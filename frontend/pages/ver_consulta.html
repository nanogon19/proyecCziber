<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>DataSage</title>
  <link rel="stylesheet" href="../styles/consulta.css">
  <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div class="sidebar">
    <header>
      <p id="abrirConexiones" class="conexiones">Conexiones</p>
    </header>
    <h2>Consultas anteriores</h2>
  </div>
  <div class="main-container">
    <header class="header">
      <div class="logo">DATASAGE</div>
      <img src="../static/img/logo.png" alt="Logo" class="logo-img">
    </header>

    <div class="result-box" id="resultBox">
      <!-- Aquí irían respuestas si decides mostrarlas -->
    </div>

    <form id="consulta-form" class="input-area">
      <textarea id="prompt" placeholder="Escriba su consulta aquí..."></textarea>
      <button type="submit">Enviar</button>
    </form>
  </div>
  <div id="conexiones" class="modal-conexiones">
    <div class="contenido-conexiones">
      <span id="cerrarConexiones" class="cerrar">&times;</span>
      <h2>Conexiones</h2>
      <div class="opciones-conexiones">
        <p id="listar" class="conexion-op">Listar conexiones</p>
        <p id="agregar" class="conexion-op">Agregar conexión</p>
      </div>
    </div>
  </div>
  <script>
    document.getElementById('consulta-form').addEventListener('submit', async function (e) {
    e.preventDefault();
    const prompt = document.getElementById('prompt').value;

    const chatBox = document.getElementById('chatBox');
    const mensaje = document.createElement('div');
    mensaje.textContent = prompt;
    mensaje.classList.add('user-message');
    resultBox.appendChild(mensaje);

    try {
      const response = await fetch('http://localhost:5000/cziber/consultar', {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json'
        },
        body: JSON.stringify({ prompt })
      });

      const json = await response.json();
      console.log("Respuesta del servidor:", json);
      if (json.mensaje) {
        alert(json.mensaje);
        return;
      }
      const {columns, data} = json;
    
      const resultBox = document.getElementById('resultBox');

      const gridContainer = document.createElement('div');
    
      new gridjs.Grid({
        columns: columns,
        data: data,
        pagination: false,
        search: true,
        sort: true,
        resizable: false,
        fixedHeader: true,
        height: '400px',
        style: {
          table: {
            'border-radius': '10px',
            'overflow': 'hidden',
            'box-shadow': '0 2px 10px rgba(0, 0, 0, 0.1)'
          },
          th: {
            'background-color': '#f4b142',
            'color': '#fff',
            'text-align': 'center'
          },
          td: {
            'text-align': 'center'
          }
        }
      }).render(gridContainer);

      resultBox.appendChild(gridContainer); 

      const exportButton = document.createElement('button');
      exportButton.textContent = 'Exportar a Excel';
      exportButton.classList.add('export-btn');
      exportButton.addEventListener("click", function () {
        const worksheetData = [columns, ...data]; // Primera fila: encabezados
        const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Resultado");

        const filename = `consulta_${Date.now()}.xlsx`;
        XLSX.writeFile(workbook, filename);
      });

      resultBox.appendChild(exportButton);
    
    }catch(e) {
      console.error("Error al enviar la consulta:", e);
      alert ("Error al enviar la consulta. Por favor, inténtelo de nuevo.");
      }
    });

    document.getElementById("abrirConexiones").addEventListener("click", function() {
      const conexiones = document.getElementById("conexiones");
      conexiones.style.display = (conexiones.style.display === "block") ? "none" : "block";
    });

    document.getElementById("cerrarConexiones").addEventListener("click", function() {
      const conexiones = document.getElementById("conexiones");
      conexiones.style.display = "none";
    });

    window.onclick = function(event) {
      const conexiones = document.getElementById("conexiones");
      if (event.target === conexiones) {
        conexiones.style.display = "none";
      }
    };

  </script>
</body>
</html>